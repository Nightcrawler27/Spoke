${DOCTYPE}
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Spoke Test Framework</title>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
        rel="stylesheet" crossorigin="anonymous"
        integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" />

    <style type="text/css">
      #result_body ul {
        list-style: none;
      }
      #result_body li span.glyphicon {
        margin-left: -2em;
        margin-right: 0.7em;
      }
      .interactive {
        cursor: pointer;
      }
      .panel-heading h3 {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: normal;
        width: 75%;
        /*padding-top: 8px; FOR BUTTONS */
      }
      .panel-heading .btn-open {
        padding: 0px 4px;
      }
      #result_body .panel-heading {
        padding: 4px 15px;
      }
      #result_body .panel-heading .panel-title {
        font-size: 14px;
        font-weight: 600;
        padding-right: 4px;
      }
      #result_body .panel-heading .time {
        margin-top: 7px;
      }
    </style>

    <script src="https://code.jquery.com/jquery-1.12.4.min.js"
        integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
        crossorigin="anonymous"></script>

  </head>
  <body>

    <nav id="header" class="navbar navbar-static-top navbar-inverse">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#/">Spoke</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <!--ul class="nav navbar-nav">
            <li><a href="#/">
              <span class="glyphicon glyphicon-th-list"></span>
              My Lists</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a class="interactive">
              <span class="glyphicon glyphicon-question-sign"></span>
              Help</a></li>
          </ul-->
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="row">
        <div class="col-xs-12">
          <div class="panel panel-default">
            <div class="panel-body">
              <h3>Spoke Test Runner<br /><small>Behavioural testing in ServiceNow</small></h3>
              <hr />
              <table class="table table-striped table-bordered">
                <tr>
                  <th class="col-xs-4 col-sm-3">Application:</th>
                  <td>${APP_NAME}</td>
                </tr>
                <tr>
                  <th class="col-xs-4 col-sm-3">Version:</th>
                  <td>${APP_VERSION}</td>
                </tr>
                <tr>
                  <th class="col-xs-4 col-sm-3">Description:</th>
                  <td>${APP_DESC}</td>
                </tr>
              </table>
            </div>
            <div class="panel-footer">
              <div class="row">
                <div class="col-sm-6">
                  <h5 class="" id="result_title" style="display: none"></h5>
                </div>
                <div class="col-sm-6">
                  <div class="text-right">
                    <button id="get_btn" class="btn btn-default"><span class="glyphicon glyphicon-search"></span> Show specs</button>
                    <button id="run_btn" class="btn btn-success"><span class="glyphicon glyphicon-play"></span>
                    <span id="run_btn_text">Execute All</span></button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-xs-12"
         id="result_body" style="display: none"></div>
      </div>

    </div>

    <script type="text/javascript">
      var SYSPARM_CK = '${SYSPARM_CK}';
      var MAX_ATTACH_SIZE = '${MAX_ATTACH_SIZE}';
    </script>

    <script type="text/javascript">

      var url_params={};window.location.search.replace(/[?${AMP}]+([^=${AMP}]+)=([^${AMP}]*)/gi,function(str,key,value){url_params[key] = value;});

      function togglePanel(forTitle) {
        $(forTitle).parent().next('.panel-body').toggle();
      }

      var spoke_client = (function () {

        var $result_title = $('#result_title');
        var $result_body = $('#result_body');

        function renderNode(node) {
          var p, li, ul, i, fails, class_name, icon;

          if (node.type == 'spec') {
            switch (node.status) {
              case 'passed':
                class_name = 'text-success';
                icon = 'ok-circle';
                break;
              case 'disabled':
              case 'pending':
                class_name = 'text-warning';
                icon = 'ban-circle';
                if (node.pendingReason) {
                  node.description += ' PENDING WITH MESSAGE: ' + node.pendingReason;
                }
                break;
              case 'failed':
                class_name = 'text-danger';
                icon = 'remove-circle';
                break;
            }
          } else {
            class_name = '';
            icon = 'list';
          }

          icon = '<span class="small glyphicon glyphicon-' + icon + '"></span> ';

          li = $('<li></li>');
          li.append('<p class="' + class_name + '">' + icon + node.description + ' <small class="pull-right">(' + node.execution_time + 'ms)</small></p>');

          if (node.status != 'pending') {
            if (node.hasOwnProperty('failed_expectations')) {
              if (node.failed_expectations.length) {
                fails = $('<table class="table table-striped table-bordered small"></table>');
                for (i = 0; node.failed_expectations.length > i; i++) {
                  fails.append('<tr class="warning"><td>' + node.failed_expectations[i] + '</td></tr>');
                }
                li.append(fails);
              }
            }
          }

          if (node.hasOwnProperty('children')) {
            if (node.children.length) {
              ul = $('<ul></ul>');
              for (i = 0; node.children.length > i; i++) {
                ul.append(renderNode(node.children[i]));
              }
              li.append(ul);
            }
          }

          return li;
        }

        function renderResults(results) {
          var ul, i, j, suite,
              $panel_title,
              $panel_body,
              details,
              api_name;

          $result_title.text('Testing ' + results.status + '. ' +
            results.total_specs + ' spec' + (results.total_specs == 1 ? '' : 's') +
            ', ' + results.failed_specs + ' failed.');

          if (results.failed_specs > 0) {
            $result_title.removeClass('text-success text-warning').addClass('text-danger');
          } else if (results.status == 'ignored') {
            $result_title.removeClass('text-success text-danger').addClass('text-warning');
          } else {
            $result_title.removeClass('text-warning text-danger').addClass('text-success');
          }

          if (!results.suites) return;
          for (i = 0; results.suites.length > i; i++) {
            suite = results.suites[i];
            details = results.details[i];
            api_name = results.details[i].api_name;

            $panel =
                $('<div class="panel"><div class="panel-heading">' +
                    '<a href="' + api.getExecuteLink(api_name) + '" onclick="spoke_client.executeTests(\'' + api_name + '\'); return false" title="Execute" class="btn btn-link btn-open">' +
                      '<span class="glyphicon glyphicon-play"></span> <span class="sr-only">Execute</span></a>' +
                    '<a href="/sys_script_include.do?sys_id=' + details.sys_id + '" onclick="$.Event(event).stopPropagation();" target="' + details.sys_id + '" title="Edit" class="btn btn-link btn-open">' +
                      '<span class="glyphicon glyphicon-edit"></span> <span class="sr-only">Edit</span></a>' +
                    '<span class="btn btn-link panel-title" onclick="togglePanel(this);">' + suite.description + '</span>' +
                    '<small class="pull-right">(' + suite.execution_time + 'ms)</small>' +
                    '<div class="clearfix"></div>' +
                  '</div></div>');
            $panel_body = $('<div class="panel-body"></div>');

            if (suite.hasOwnProperty('children')) {
              ul = $('<ul></ul>');
              for (j = 0; suite.children.length > j; j++) {
                ul.append(renderNode(suite.children[j]));
              }
              $panel_body.append(ul);
            }

            if ($panel_body.find('.text-danger').length) {
              $panel.addClass('panel-danger');
            } else {
              $panel.addClass('panel-success');
              if (results.suites.length > 1) $panel_body.hide();
            }

            $panel.append($panel_body);
            $result_body.append($panel);
          }

        }

        function renderSpecs(specs) {
          var $list_group,
              $panel,
              spec,
              i;

          $result_title.text('Found ' + specs.length + ' spec' + (specs.length == 1 ? '' : 's'));
          if (specs.length) {
            $result_title.removeClass('text-warning text-danger').addClass('text-success');
          } else {
            $result_title.removeClass('text-success text-danger').addClass('text-warning');
            return;
          }

          $list_group = $('<div class="list-group"></div>');
          for (i = 0; specs.length > i; i++) {
            spec = specs[i];
            $item =
                '<div class="list-group-item list-group-item-warning">' +
                  spec.name +
                  '<div class="pull-right">' +
                    '<a class="btn btn-link" href="/sys_script_include.do?sys_id=' + spec.sys_id + '" target="' + spec.sys_id + '">' +
                      '<span class="glyphicon glyphicon-edit"></span> Edit</a>' +
                    '<a class="btn btn-success" onclick="spoke_client.executeTests(\'' + spec.api_name + '\'); return false" href="' + api.getExecuteLink(spec.api_name) + '">' +
                      '<span class="glyphicon glyphicon-play"></span> Execute</a>' +
                  '</div>' +
                  '<div class="small">Updated: ' + spec.updated + '</div>' +
                '</div>';
            $list_group.append($item);
          }
          $result_body.append($list_group);
        }

        var api = {};

        api.current_script = url_params.script;

        api.getAvailableSpecs = function () {
          var url = ['?action=getAvailableSpecs'];
          if ('sys_scope' in url_params) url.push('sys_scope=' + url_params.sys_scope);
          api.current_script = '';
          return api.run(url.join('${AMP}'), function (data) {
            if (data.$success) {
              renderSpecs(data.specs);
              $result_title.show();
              $result_body.show();
            } else {
              alert('AJAX operation failed: ' + data.$error);
            }
          });
        };

        api.getExecuteLink = function (script) {
          var url = ['?action=executeTests'];
          if ('sys_scope' in url_params) url.push('sys_scope=' + url_params.sys_scope);
          if (script) url.push('script=' + script);
          return url.join('${AMP}');
        };

        api.executeTests = function (script) {
          if (arguments.length > 0) api.current_script = script;
          return api.run(api.getExecuteLink(api.current_script), function (data) {
            if (data.$success) {
              renderResults(data.results);
              $result_title.show();
              $result_body.show();
            } else {
              alert('AJAX operation failed: ' + data.$error);
            }
          });
        };

        api.run = function (url, callback) {

          $result_title.removeClass().addClass('text-primary').text('Running...');

          url += '${AMP}sysparm_ck=' + SYSPARM_CK;

          $('#run_btn').prop('disabled', true)
          $('#get_btn').prop('disabled', true);

          $result_body.empty();


          return $.ajax({
            url: url,
            dataType: 'json',
            statusCode: {
              401: function () {
                window.location.reload();
              }
            }
          }).then(callback, function (xhr) {
            alert('Failed to execute AJAX request to run tests.');
          }).then(function () {
            $('#run_btn').prop('disabled', false);
            $('#run_btn_text').text(spoke_client.current_script ? 'Execute' : 'Execute All');
            $('#get_btn').prop('disabled', false);
          });
        }

        return api;
      })();

      $('#run_btn').click(function () {
        $('#run_btn_text').text('Running...');
        spoke_client.executeTests();
      });

      $('#get_btn').click(function () {
        spoke_client.getAvailableSpecs();
      });

      // if no script has been requested then show the available specs
      if (!url_params.script) {
        spoke_client.getAvailableSpecs();
      }

    </script>

  </body>
</html>